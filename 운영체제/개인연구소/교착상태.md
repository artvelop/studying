# 교착상태

교착상태는 다중 프로그래밍 시스템에서 프로세스가 결코 일어나지 않을 사건을 기다리는 상태에 빠진경우를 말한다

일괄처리시스템의 경우에는 교착상태가 자주 발생하지 않는다. 왜냐하면 사용자가 작업을 완료하는데 필요한 자원을 명시했기 때문이다.

반면에 대화식 시스템에서는 동적 자원을 공유하여 자원의 사용률을 높이는 과정에서 교착 상태가 발생할 가능성이 있다


### 보통 프로세스는 다음 순서로 자원을 이용한다.

1. 자원 요청

    + 프로세스가 필요한 자원을 요청한다

2. 자원 사용

    + 프로세스가 요청한 자원을 획득하여 사용한다

3. 자원 해제

    + 프로세스가 자원 상용르 마친 후 해당 자원을 되돌려준다

여기서 자원의 요청과 해제는 시스템 호출로만 가능하다

파일이나 입출력 장치등 읽거나 쓰는 일 또한 시스템 호출로만 가능하다

### 교착상태의 예

1. 스풀링 시스템에서 발생하는 교착 상태

    + 비교적 쉽게 교착 상태에 빠짐
    + 디스크에 할당된 스풀 공간의 출력을 완료하지 않은 상태에서 다른 작업이 스풀 공간을 모두 차지하면 교착 상태가 발생함

2. 디스크를 공유할 때 발생하는 교착 상태

    + 디스크 사용에 제어가 없으면 프로세스들이 서로 충돌하는 명령을 요청할 때 발생

3. 네트워크에서 발생하는 교착 상태

    + 네트워크가 붐비거나 입출력 버퍼 공간이 부족한 네트워크 시스템에 메세지 흐름을 제어하는 적절한 프로토콜이 없으면 교착 상태가 발생할 수 있음

## 교착 상태의 발생 조건

교착상태는 시스템에서 다음 네 가지 조건을 만족할 때 발생한다.

1 ~ 3만 만족해도 교착 상태가 발생할 수 있는데, 발생하지 않을 수도 있다

4번은 1 ~ 3 조건을 만족할 때 발생할 수 있는 결과이고, 점유와 대기조건을 포함하기 때문에 네 가지 조건이 모두 독립적인 것은 아니다

1. 상호배제

    + 자원을 최소 하나 이상 비공유해야한다
    + 사용중인 자원을 다른 프로세스가 사용하려면 요청한 자원이 해제될 때까지 기다려야 한다

2. 점유와 대기

    + 자원을 최소한 하나 정도는 보유한다
    + 다른 프로세스에 할당된 자원을 얻으려고 기다리는 프로세스가 있어야 한다.

3. 비선점

    + 자원은 선점할 수 없다.
    + 자원은 강제로 빼앗을 수 없고, 자원을 점유하고 있는 프로세스가 끝나야 해제된다.

4. 순환(환형) 대기

    ![순환 대기](./resource/sohan.png)

## 교착 상태의 해결 방법

우선 해결방법은 크게 3가지로 나뉜다

1. 교착 상태가 발생하지 않도록 예방하는 방법

2. 교착 상태의 발생 가능성을 배제하지 않고 이를 적절히 회피하는 방법

3. 교착 상태를 허용하되 교착 상태를 탐지하여 다시 회복하는 방법

## 교착 상태 예방

앞서 말한 4가지 조건이 발생하지 않도록하는걸 예방하는거라한다

1968년도 하벤더의 경우 상호배제를 제외한 다음 세 가지 교착 상태 예방 방법을 제안했다.

+ 각 프로세스는 필요한 자원을 한 번에 모두 요청해야 하며, 요청한 자원을 모두 제공받기 전까지는 직업을 진행할 수 없다

+ 어떤 자원을 점유하고 있는 프로세스의 요청을 더 이상 허용하지 않으면 점유한 자원을 모두 반납하고, 필요할 때 다시 자원을 요청해야 한다.

+ 모든 프로세스에 자원을 순서대로 할당해야 한다. 모든 프로세스에 각 자원 유형별로 할당 순서를 부여한 후 순서에 따라 자원을 요청하게 한다.

보통 교착 상태는 다음 네 가지 방법으로 예방할 수 있다.

1. 자원의 상호배제 조건 방지

    + 상호배제는 자원의 비공유가 전제되어야 한다.

    + ex) 읽기전용파일

2. 점유와 대기 조건 방지

    + 시스템에서 점유와 대기 조건이 발생하지 않으려면 프로세스가 작업을 수행하기전에 필요한 자원을 모두 요청하고 획득해야 한다.

    + 쉽게 말해서 자원을 전부 가져감

    + 방법

        + 자원을 할당할 때 시스템 호출된 프로세스 하나를 실행하는데 필요한 모든 자원을 먼저 할당하여 실행한 후 다른 시스템 호출에 자원을 할당하는 것이다.

        + 프로세스가 자원을 전혀 갖고 있지 않을 때만 자원을 요청할 수 있도록 허용하는 것이다.
    
    + 단점

        + 자원의 효율성이 너무 낮다.

        + 기아 상태가 발생할 수 있다.

3. 비선점 조건 방지

    + 전제 조건은 이미 할당된 자원에 선점권이 없어야한다.

4. 순환(환형) 대기 조건 방지

    + 모든 자원에 일련의 순서를 부여하고 각 프로세스가 오름차순으로만 자원을 요청할 수 있게 하는 것

    + 이는 계층적 요청 방법으로 순환 대기의 가능성을 제거하여 교착 상태를 예방할 수 있다

    + 상당한 자원 낭비를 초래한다는 단점이 있다

## 교착상태 회피

교착 상태 회피는 교착상태의 발생가능성을 미리 제거하는 것이 아님

그럼 어떤거냐,

교착 상태가 발생할 가능성을 인정하고 교착 상태가 발생하려고 할 때 적절히 회피하는 것

따라서 예방보다는 회피가 더 병행성을 허용함

방법은 두가지로 설명된다.

1. 프로세스의 시작 중단

    + 프로세스의 요구가 교착 상태를 발생시킬 수 있다면 프로세스 시작을 중단함

    + 이 예시는 프로세스에 최대 요청량이 필요하다는 최악의 상황이므로 바람직하지 않다.

    + 안정상태와 불안정상태 파악하기

2. 자원 할당 거부

    + 프로세스가 요청한 자원을 할당했을 때 교착 상태가 발생할 수 있다면 요청한 자원을 할당하지 않는다. 이를 보통 은행가 알고리즘이라고 한다.

    + 은행가 알고리즘 파악하기


### 프로세스의 시작 중단

우선 교착상태를 회피하려면 자원을 언제 추가 요청하는지 추가 정보가 필요하다

각 프로세스마다 요청과 해제에서 정확한 순서를 파악하고 있다면, 요청에 따른 프로세스 대기 여부를 결정할 수 있다.

그러므로 각 프로세스가 필요한 자원의 최대치를 선언하는 것이 간단하고 유용한 알고리즘이다.

+ 교착 상태 회피 알고리즘

    + 시스템이 순환 대기 조건이 발생하지 않도록 자원 할당 상태를 검사한다.

    + 자원 할당 상태는 사용 가능한 자원 수, 프로세스들의 최대 요청 수로 정의한다.

    + 시스템에 안정 순서가 있으면 그 시스템은 안정하다

+ 시스템의 상태 (안정 상태 & 불안정 상태)

    + 안정 상태
        
        + 모든 사용자가 일정 기간 안에 작업을 끝낼 수 있도록 운영체제가 할 수 있을 때 뜻함

    + 불안정 상태

        + 그렇지 않을 경우를 뜻함

        + 모든 불안정 상태는 교착상태가 아니다?

            + 불안정 상태는 교착 상태가 되기 쉬울뿐 모든 불안정 상태가 교착상태는 아니다

            + 안정상태 > 불안정 상태 > 교착 상태

    + 이거 표로 주어졌을 때 파악하는 연습 필요함

### 자원 할당 거부(은행가 알고리즘)

1. 자원의 할당 허용 여부를 결정하기 전에 미리 결정된 모든 자원의 최대 가능한 할당량을 시뮬레이션하여 안전 여부를 검사한다.

2. 대기 중인 다른 모든 활동의 교착 상태 가능성을 조사하여 '안전 상태' 여부를 검사하고 확인한다.

여기서 우리는 안전 알고리즘에 집중을 해야한다

+ 안전 알고리즘 꼭 박살내기

## 기아상태

+ 작업이 결코 사용할 수 없는 자원을 계속 기다리는 결과를 예방하려고 자원을 할당할 때 발생하는 결과

+ 교착 상태의 해결책은 기아 상태의 가능성을 제거하지 못한다

    + 따라서 기아 상태 해결은 먼저 기다리는 작업을 발견하고 각 작업이 기다린 시간을 조사하고 추적해야 한다.

+ 시스템은 기아 상태를 발견하면 즉시 새로운 작업의 시작을 기대하도록 조치해야한다.

    + 이경우 빈번한 시스템 대기로 처리량이 감소할 수 있으므로 매우 신중한 접근이 필요하다

    
